<h1 class="wmd-title" id="wellbehaved">Wellbehaved</h1>

<p>Обертка вокруг питоновского проекта <code>behave</code> (который, в свою очередь, является портом <code>Cucumber</code> из Ruby), позволяющая автоматически прогонять feature-файлы в качестве Django-тестов.</p><h2 class="wmd-title" id="использование">Использование</h2>

<ul>
<li>Установите пакет <code>wellbehaved</code> со стандартного PyPi-сервера "БАРС Груп":</li>
</ul>

<pre class="prettyprint prettyprinted" style=""><code><span class="pln">pip install wellbehaved </span><span class="pun">-</span><span class="pln">i https</span><span class="pun">:</span><span class="com">//&lt;PyPi_сервер_БАРС_Груп&gt;/simple</span></code></pre>

<ul>
<li>Добавьте его в <code>INSTALLED_APPS</code> проекта:</li>
</ul>

<pre class="prettyprint prettyprinted" style=""><code><span class="pln">INSTALLED_APPS </span><span class="pun">+=</span><span class="pln"> </span><span class="pun">(</span><span class="str">'wellbehaved'</span><span class="pun">,)</span></code></pre>

<ul>
<li>Расположите файлы с описанием поведения (<em>&lt;имя фичи&gt;.feature</em>) одним из следующих способов:
<ul><li>одна из списка папок, указанного в настройке <code>WELLBEHAVED_SEARCH_DIRECTORIES</code>;</li>
<li>в одной из подпапок корня проекта (настройка <code>PROJECT_ROOT</code>)</li></ul></li>
<li>Запустить тестирование можно с помощью обычной команды:</li>
</ul>

<pre class="prettyprint prettyprinted" style=""><code><span class="pln">python </span><span class="pun">./</span><span class="pln">manage</span><span class="pun">.</span><span class="pln">py test wellbehaved</span></code></pre><h2 class="wmd-title" id="принцип-работы">Принцип работы</h2>

<p>При запуске тестирования <em>wellbehaved</em> обходит все поддиректории в корне проекта (местоположение <em>manage.py</em>) и ищет в них
папки <em>features</em>. Каждая найденная папка будет представлена отдельным набором тестов, в котором каждый файл с расширением 
<em>.feature</em> будет обернут в класс <strong>DjangoBDDTestCase</strong>.</p>

<p>Для каждого модуля с папкой features создается отдельный метод: <code>test_имяфайла_feature</code>. 
Таким образом, вы можете протестировать единичную функцию системы:</p>

<pre><code>+ core
    |
    +- features
              |
              + - core_func.feature

python ./manage.py test wellbehaved.DjangoBDDTestCase.test_core_func_feature
</code></pre><h2 class="wmd-title" id="настройки">Настройки</h2>

<p>Настройки являются необязательными считываются из <code>settings.py</code> проекта:</p>

<ol>
<li><p><code>WELLBEHAVED_USE_EXISTING_DB</code> - использовать для тестирования существующую базу, используется вместе с 
<code>TEST_RUNNER = 'wellbehaved.runner.ExistingDBRunner'</code></p></li>
<li><p><code>WELLBEHAVED_INITIAL_FIXTURES</code> - список фикстур, который будет загружен каждым тестом. Обычно ииспользуется для занесения общих значений в справочники и по формату аналогичен аттрибуту <em>fixtures</em> в <em>TestCase</em>.</p></li>
<li><p><code>WELLBEHAVED_FORMATTER</code> - модуль форматирования, используемый <em>behave</em> для вывода результатов. Возможные варианты описаны в <a href="http://pythonhosted.org/behave/formatters.html">списке модулей форматирования behave</a>, по умолчанию стоит <code>[pretty]</code>.</p></li>
<li><p><code>WELLBEHAVED_LANG</code> - код языка, на котором написано описание функционала. По умолчанию стоит <code>'ru'</code>.</p></li>
</ol><h2 class="wmd-title" id="gherkin">Gherkin</h2>

<p>(здесь и далее - перевод и легкая адаптация статьи <a href="http://docs.behat.org/guides/1.gherkin.html">"Writing Features - Gherkin Language"</a>)</p>

<p><strong>Gherkin</strong> - человеко-читаемый язык для описания поведения системы, который использует отступы для задания структуры документа,
(пробелы или символы табуляции). Каждая строчка начинается с одного из ключевых слов и описывает один из шагов.</p>

<p>Пример:</p>

<pre><code>Функция: Короткое, но исчерпывающее описание требуемого функционала
    Для того, чтобы достичь определенных целей
    В качестве определенного участника взаимодействия с системой
    Я хочу получить определенную пользу

    Сценарий: Какая-то определенная бизнес-ситуация
        Дано какое-то условие
        И ещё одно условие
        Когда предпринимается какое-то действие участником
        И им делается ещё что-то
        И вдобавок он совершил что-то ещё
        То получается какой-то проверяемый результат
        И что-то ещё случается, что мы можем проверить
</code></pre>

<p>Обработчик разбивает файл с тестами на функции, сценарии и входящие в них шаги. Давайте разберем 
этот пример:</p>

<ol>
<li><p>Строка <strong>Функция: Короткое, но исчерпывающее описание требуемого функционала</strong> начинает собой
описание функционала и дает ему название.</p></li>
<li><p>Следующие три строчки не обрабатываются и не несут никакой смысловой нагрузке для обработчика тестов,
но они задают контекст тестирования и одновременно описывают, какую пользу мы получим от этого функционала.</p></li>
<li><p>Строка <strong>Сценарий: Какая-то определенная бизнес-ситуация</strong> начинает сценарий и содержит его описание.</p></li>
<li><p>Следующие 7 строчек описывают шаги теста, каждому из которых впоследствии
будет сопоставлен определенный программный код, выполняющий описанное действие.
Сопоставлению подлежат части строк лежащие после ключевых слов "Дано", "И", "Когда" и т.д.</p></li>
</ol>

<h3 class="wmd-title" id="функции-(feature)">Функции (Feature)</h3>

<p>Каждая функция описывается в отдельном файле с расширением <em>.feature</em>. Первая строчка
должна начинаться с ключевого слова "Функция:", за которой могут идти три строчки с описанием,
размеченные отступами. Каждая функция обычно состоит из списка сценариев. </p>

<p>Каждый сценарий состоит из списка <em>шагов</em>, каждый из которых должен начинаться с одного из ключевых слов:</p>

<ul>
<li>Дано</li>
<li>Когда</li>
<li>То</li>
<li>Но</li>
<li>И</li>
</ul>

<p>Шаги <em>"Но"</em> и <em>"И"</em> существуют исключительно для удобства чтения и по своим функциям повторяют ключевое слово,
с которого начиналась предыдущая строчка.</p>

<p>Вдобавок к сценариям, описание функционала может также содержать <em>структуры сценариев</em> и <em>предыстории</em>.</p>

<h3 class="wmd-title" id="сценарий-(scenario)">Сценарий (Scenario)</h3>

<p>Сценарий представляет собой одну из ключевых структур в языке <em>Gherkin</em>. Каждый сценарий начинается
с ключевого слова <strong>"Сценарий:"</strong>, и может содержать в себе название сценария. Описание функционала
может содержать в себе один или больше сценариев, и каждый сценарий состоит из одного или более шага.</p>

<p>Каждый из следующих сценариев содержит три шага:</p>

<pre><code>Сценарий: Вася создает новую запись
    Дано я вошел в систему как Вася
    Когда я пытаюсь добавить запись в справочник "Лекарства"
    То мне должен быть ответ "Ваша запись успешно добавлена."

Сценарий: Вася не может добавлять запись в справочник лечений
    Дано я вошел в систему как Вася
    Когда я пытаюсь добавить запись в справочник "Виды лечений"
    То мне должен быть ответ "У вас нет прав доступа!"
</code></pre>

<h3 class="wmd-title" id="структура-сценария-(scenario-outline)">Структура сценария (Scenario Outline)</h3>

<p>Достаточно часто приходится писать множество мелких сценариев, которые различаются буквально парой
переменных. Эти повторения могут быстро надоесть:</p>

<pre><code>Сценарий: удалить 5 записей из 12
    Дано есть 12 записей
    Когда я удаляю 5 записей
    То у меня должно остаться 7 записей

Сценарий: удалить 5 записей из 20
    Дано есть 20 записей
    Когда я удаляю 5 записей
    То у меня должно остаться 15 записей
</code></pre>

<p>Структуры сценариев позволяют нам более кратко описывать подобные наборы сценариев
с помощью шаблонов:</p>

<pre><code>Структура сценария: удаление записей
    Дано есть &lt;было&gt; записей
    Когда я удаляю &lt;удалено&gt; записей
    То у меня должно остаться &lt;остаток&gt; записей

    Примеры:
        | было  | удалено | остаток |
        | 12    |    5    |   7     |
        | 20    |    5    |   15    |
</code></pre>

<p>Шаги указанные в структуре сценария не выполняются напрямую, но используются 
для подстановки в них значений из таблицы примеров. Каждая строчка таблицы
будет обрабатываться как отдельный сценарий с указанными значениями вместо
заглушек "было", "удалено" и "стало".</p>

<h3 class="wmd-title" id="предыстории-(background)">Предыстории (Background)</h3>

<p>Предыстории позволяют вам добавить определенный контекст ко всем сценариям в 
пределах функции. По сути, предыстория - сценарий без имени, состоящий из
шагов. Основное отличие в запуске: предыстория запускается перед каждым
сценарием:</p>

<pre><code>Функция: поддержка многих справочников

    Предыстория:
        Дано есть пользователь с именем "Вася"
        И есть справочник "Лекарства"
        И у пользователя "Вася" есть право на запись в  "Лекарство"
        И есть справочник "Виды лечений"

    Сценарий: Вася создает новую запись
        Дано я вошел в систему как Вася
        Когда я пытаюсь добавить запись в справочник "Лекарства"
        То мне должен быть ответ "Ваша запись успешно добавлена."

    Сценарий: Вася не может добавлять запись в справочник лечений
        Дано я вошел в систему как Вася
        Когда я пытаюсь добавить запись в справочник "Виды лечений"
        То мне должен быть ответ "У вас нет прав доступа!"
</code></pre>

<h3 class="wmd-title" id="шаги">Шаги</h3>

<p>Функции состоят из шагов, также известных как <em>Данные</em>, <em>Действия</em> и <em>Результаты</em>.</p>

<h4 class="wmd-title" id="данные-(givens)">Данные (Givens)</h4>

<p>Назначение шагов <em>Дано</em> состоит в <strong>приведение системы в известное состояние</strong>
перед тем как пользователь (или внешняя система) начнет взаимодействие с системой
(в шагах <em>Когда</em>). Также можно рассматривать их как предусловия.</p>

<p>Пример: создавать объекты сущностей или настраивать БД</p>

<pre><code>Дано нет пользователей в базе
Дано база данных пустая
</code></pre>

<p>Пример: вход пользователя в систему (исключение к правилу "никаких взаимодействий в шаге Дано")</p>

<pre><code>Дано я вошел в систему как "Вася"
</code></pre>

<h4 class="wmd-title" id="действия-(whens)">Действия (Whens)</h4>

<p>Назначение шагов <em>Когда</em> состоит в <strong>описании ключевого действия, совершаемого пользователем</strong>.</p>

<p>Пример: взаимодействие со страницей</p>

<pre><code>Когда я открыл форму добавления учреждения
Когда я ввел "Институт радости" в поле "Наименование"
Когда я выбрал в поле "Тип" значение "Институт"
Когда я нажал на кнопку "Сохранить"
</code></pre>

<h4 class="wmd-title" id="результаты-(thens)">Результаты (Thens)</h4>

<p>Назначение шагов <em>То</em> состоит в <strong>наблюдении результатов выполнения действий</strong>. Наблюдения должны быть связаны с явной пользой, которая указаны в описании функции. Также необходимо помнить, что должен проверяться <em>вывод системы</em> (отчеты, интерфейс, сообщения), а не что-то глубоко закопанное в систему.</p><h4 class="wmd-title" id="предлоги-(and,-but)">Предлоги (And, But)</h4>

<p>Если у вас есть несколько шагов <em>Дано</em>, <em>Когда</em>, или <em>То</em>
то вы можете писать так:</p>

<pre><code>Сценарий: множественные данные
    Дано что-то первое
    Дано что-то второе
    Дано и что-то ещё
    Когда я открою свои глаза
    То я увижу что-то
    То чего-то я не увижу
</code></pre>

<p>...или можете использовать шаги <em>И</em> и <em>Но</em>, превращая свой сценарий в нечто более читаемое:</p>

<pre><code>Сценарий: множественные данные
    Дано что-то первое
    И что-то второе
    И и что-то ещё
    Когда я открою свои глаза
    То я увижу что-то
    Но чего-то я не увижу
</code></pre>

<h4 class="wmd-title" id="таблицы">Таблицы</h4>

<p>Регулярные выражения, с помощью которых программисты получают
данные из текстового описания шагов позволяют получать небольшие куски данных из самой строчки. Но бывает и такое, что необходимо передать больший объем данных в один шаг. И здесь нам на помощь придут таблицы:</p>

<pre><code>Сценарий:
    Дано существуют следующие пользователи:
        | Логин | E-mail        | Пароль |
        | user1 | user1@mail.ru | pass1  |
        | joe   | joe@gmail.com | hey    |
        | heyho | hey@hoe.com   | joe    |
</code></pre><h2 class="wmd-title" id="контакты">Контакты</h2>

<p>С вопросами по доработкам, применению и с сообщениями об ошибках пишите на <a href="mailto:borisov@bars-open.ru">borisov@bars-open.ru</a></p>

<h2 class="wmd-title" id="благодарности">Благодарности</h2>

<ul>
<li>Юле Касимовой (<a href="mailto:kasimova@bars-open.ru">kasimova@bars-open.ru</a>) - самоотверженное участие в тестировании продукта;</li>
<li>Сергею Чипиге (<a href="mailto:svchipiga@bars-open.ru">svchipiga@bars-open.ru</a>) - нахождение багов;</li>
<li>Вадиму Малышеву (<a href="mailto:vvmalyshev@bars-open.ru">vvmalyshev@bars-open.ru</a>) - продавливании идеи изучения концепций BDD.</li>
</ul><h2 class="wmd-title" id="ссылки">Ссылки</h2>

<ul>
<li><a href="http://docs.behat.org/guides/1.gherkin.html">Writing Features - Gherkin Language</a></li>
<li><a href="http://pythonhosted.org/behave/philosophy.html">Behavior Driven Development (from behave documentation)</a></li>
<li><a href="http://pythonhosted.org/behave/formatters.html">List of behave formatters</a></li>
</ul>